version: 0.2
env:
  variables:
      VERSION_TAG: ${CODEBUILD_BUILD_ID}
      IMAGE_URI: ${URL_ECR}:${VERSION_TAG}
phases:
  pre_build:
    on-failure: ABORT
    commands:
      - echo "Logando no Amazon ECR  (${URL_ECR})..."
      - aws --version
      - aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${URL_ECR}
  build:
    on-failure: ABORT
    commands:
      - echo "Iniciando contrução da imagem ${date}"
      - docker build -t app_storage  -f ./Dockerfile.aws
      - docker tag app_storage:latest ${URL_ECR}:latest
  post_build:
    on-failure: ABORT
    commands:
      - echo Atualizando imagem no repositório...
      - docker push ${URL_ECR}:latest
      - echo Escrevendo arquivo imagedefinitions.json
      - printf '[{"name":"app_storage","imageUri":"%s"}]' ${IMAGE_URI}  > imagedefinitions.json
      - cat imagedefinitions.json
artifacts:
  files: imagedefinitions.json
